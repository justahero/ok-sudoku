use std::fmt::Display;

use crate::Sudoku;

pub(crate) static BLOCKS: [[u8; 9]; 9] = [
    [00, 01, 02, 09, 10, 11, 18, 19, 20],
    [03, 04, 05, 12, 13, 14, 21, 22, 23],
    [06, 07, 08, 15, 16, 17, 24, 25, 26],
    [27, 28, 29, 36, 37, 38, 45, 46, 47],
    [30, 31, 32, 39, 40, 41, 48, 49, 50],
    [33, 34, 35, 42, 43, 44, 51, 52, 53],
    [54, 55, 56, 63, 64, 65, 72, 73, 74],
    [57, 58, 59, 66, 67, 68, 75, 76, 77],
    [60, 61, 62, 69, 70, 71, 78, 79, 80],
];

pub(crate) static ROWS: [[u8; 9]; 9] = [
    [00, 01, 02, 03, 04, 05, 06, 07, 08],
    [09, 10, 11, 12, 13, 14, 15, 16, 17],
    [18, 19, 20, 21, 22, 23, 24, 25, 26],
    [27, 28, 29, 30, 31, 32, 33, 34, 35],
    [36, 37, 38, 39, 40, 41, 42, 43, 44],
    [45, 46, 47, 48, 49, 50, 51, 52, 53],
    [54, 55, 56, 57, 58, 59, 60, 61, 62],
    [63, 64, 65, 66, 67, 68, 69, 70, 71],
    [72, 73, 74, 75, 76, 77, 78, 79, 80],
];

pub(crate) static COLS: [[u8; 9]; 9] = [
    [00, 09, 18, 27, 36, 45, 54, 63, 72],
    [01, 10, 19, 28, 37, 46, 55, 64, 73],
    [02, 11, 20, 29, 38, 47, 56, 65, 74],
    [03, 12, 21, 30, 39, 48, 57, 66, 75],
    [04, 13, 22, 31, 40, 49, 58, 67, 76],
    [05, 14, 23, 32, 41, 50, 59, 68, 77],
    [06, 15, 24, 33, 42, 51, 60, 69, 78],
    [07, 16, 25, 34, 43, 52, 61, 70, 79],
    [08, 17, 26, 35, 44, 53, 62, 71, 80],
];

pub(crate) static HOUSES: [[u8; 20]; 81] = [
    [01, 02, 03, 04, 05, 06, 07, 08, 09, 10, 11, 18, 19, 20, 27, 36, 45, 54, 63, 72],
    [00, 02, 03, 04, 05, 06, 07, 08, 09, 10, 11, 18, 19, 20, 28, 37, 46, 55, 64, 73],
    [00, 01, 03, 04, 05, 06, 07, 08, 09, 10, 11, 18, 19, 20, 29, 38, 47, 56, 65, 74],
    [00, 01, 02, 04, 05, 06, 07, 08, 12, 13, 14, 21, 22, 23, 30, 39, 48, 57, 66, 75],
    [00, 01, 02, 03, 05, 06, 07, 08, 12, 13, 14, 21, 22, 23, 31, 40, 49, 58, 67, 76],
    [00, 01, 02, 03, 04, 06, 07, 08, 12, 13, 14, 21, 22, 23, 32, 41, 50, 59, 68, 77],
    [00, 01, 02, 03, 04, 05, 07, 08, 15, 16, 17, 24, 25, 26, 33, 42, 51, 60, 69, 78],
    [00, 01, 02, 03, 04, 05, 06, 08, 15, 16, 17, 24, 25, 26, 34, 43, 52, 61, 70, 79],
    [00, 01, 02, 03, 04, 05, 06, 07, 15, 16, 17, 24, 25, 26, 35, 44, 53, 62, 71, 80],
    [00, 01, 02, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 27, 36, 45, 54, 63, 72],
    [00, 01, 02, 09, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 28, 37, 46, 55, 64, 73],
    [00, 01, 02, 09, 10, 12, 13, 14, 15, 16, 17, 18, 19, 20, 29, 38, 47, 56, 65, 74],
    [03, 04, 05, 09, 10, 11, 13, 14, 15, 16, 17, 21, 22, 23, 30, 39, 48, 57, 66, 75],
    [03, 04, 05, 09, 10, 11, 12, 14, 15, 16, 17, 21, 22, 23, 31, 40, 49, 58, 67, 76],
    [03, 04, 05, 09, 10, 11, 12, 13, 15, 16, 17, 21, 22, 23, 32, 41, 50, 59, 68, 77],
    [06, 07, 08, 09, 10, 11, 12, 13, 14, 16, 17, 24, 25, 26, 33, 42, 51, 60, 69, 78],
    [06, 07, 08, 09, 10, 11, 12, 13, 14, 15, 17, 24, 25, 26, 34, 43, 52, 61, 70, 79],
    [06, 07, 08, 09, 10, 11, 12, 13, 14, 15, 16, 24, 25, 26, 35, 44, 53, 62, 71, 80],
    [00, 01, 02, 09, 10, 11, 19, 20, 21, 22, 23, 24, 25, 26, 27, 36, 45, 54, 63, 72],
    [00, 01, 02, 09, 10, 11, 18, 20, 21, 22, 23, 24, 25, 26, 28, 37, 46, 55, 64, 73],
    [00, 01, 02, 09, 10, 11, 18, 19, 21, 22, 23, 24, 25, 26, 29, 38, 47, 56, 65, 74],
    [03, 04, 05, 12, 13, 14, 18, 19, 20, 22, 23, 24, 25, 26, 30, 39, 48, 57, 66, 75],
    [03, 04, 05, 12, 13, 14, 18, 19, 20, 21, 23, 24, 25, 26, 31, 40, 49, 58, 67, 76],
    [03, 04, 05, 12, 13, 14, 18, 19, 20, 21, 22, 24, 25, 26, 32, 41, 50, 59, 68, 77],
    [06, 07, 08, 15, 16, 17, 18, 19, 20, 21, 22, 23, 25, 26, 33, 42, 51, 60, 69, 78],
    [06, 07, 08, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 26, 34, 43, 52, 61, 70, 79],
    [06, 07, 08, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 35, 44, 53, 62, 71, 80],
    [00, 09, 18, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 45, 46, 47, 54, 63, 72],
    [01, 10, 19, 27, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 45, 46, 47, 55, 64, 73],
    [02, 11, 20, 27, 28, 30, 31, 32, 33, 34, 35, 36, 37, 38, 45, 46, 47, 56, 65, 74],
    [03, 12, 21, 27, 28, 29, 31, 32, 33, 34, 35, 39, 40, 41, 48, 49, 50, 57, 66, 75],
    [04, 13, 22, 27, 28, 29, 30, 32, 33, 34, 35, 39, 40, 41, 48, 49, 50, 58, 67, 76],
    [05, 14, 23, 27, 28, 29, 30, 31, 33, 34, 35, 39, 40, 41, 48, 49, 50, 59, 68, 77],
    [06, 15, 24, 27, 28, 29, 30, 31, 32, 34, 35, 42, 43, 44, 51, 52, 53, 60, 69, 78],
    [07, 16, 25, 27, 28, 29, 30, 31, 32, 33, 35, 42, 43, 44, 51, 52, 53, 61, 70, 79],
    [08, 17, 26, 27, 28, 29, 30, 31, 32, 33, 34, 42, 43, 44, 51, 52, 53, 62, 71, 80],
    [00, 09, 18, 27, 28, 29, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 54, 63, 72],
    [01, 10, 19, 27, 28, 29, 36, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 55, 64, 73],
    [02, 11, 20, 27, 28, 29, 36, 37, 39, 40, 41, 42, 43, 44, 45, 46, 47, 56, 65, 74],
    [03, 12, 21, 30, 31, 32, 36, 37, 38, 40, 41, 42, 43, 44, 48, 49, 50, 57, 66, 75],
    [04, 13, 22, 30, 31, 32, 36, 37, 38, 39, 41, 42, 43, 44, 48, 49, 50, 58, 67, 76],
    [05, 14, 23, 30, 31, 32, 36, 37, 38, 39, 40, 42, 43, 44, 48, 49, 50, 59, 68, 77],
    [06, 15, 24, 33, 34, 35, 36, 37, 38, 39, 40, 41, 43, 44, 51, 52, 53, 60, 69, 78],
    [07, 16, 25, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 44, 51, 52, 53, 61, 70, 79],
    [08, 17, 26, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 51, 52, 53, 62, 71, 80],
    [00, 09, 18, 27, 28, 29, 36, 37, 38, 46, 47, 48, 49, 50, 51, 52, 53, 54, 63, 72],
    [01, 10, 19, 27, 28, 29, 36, 37, 38, 45, 47, 48, 49, 50, 51, 52, 53, 55, 64, 73],
    [02, 11, 20, 27, 28, 29, 36, 37, 38, 45, 46, 48, 49, 50, 51, 52, 53, 56, 65, 74],
    [03, 12, 21, 30, 31, 32, 39, 40, 41, 45, 46, 47, 49, 50, 51, 52, 53, 57, 66, 75],
    [04, 13, 22, 30, 31, 32, 39, 40, 41, 45, 46, 47, 48, 50, 51, 52, 53, 58, 67, 76],
    [05, 14, 23, 30, 31, 32, 39, 40, 41, 45, 46, 47, 48, 49, 51, 52, 53, 59, 68, 77],
    [06, 15, 24, 33, 34, 35, 42, 43, 44, 45, 46, 47, 48, 49, 50, 52, 53, 60, 69, 78],
    [07, 16, 25, 33, 34, 35, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 53, 61, 70, 79],
    [08, 17, 26, 33, 34, 35, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 62, 71, 80],
    [00, 09, 18, 27, 36, 45, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 72, 73, 74],
    [01, 10, 19, 28, 37, 46, 54, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 72, 73, 74],
    [02, 11, 20, 29, 38, 47, 54, 55, 57, 58, 59, 60, 61, 62, 63, 64, 65, 72, 73, 74],
    [03, 12, 21, 30, 39, 48, 54, 55, 56, 58, 59, 60, 61, 62, 66, 67, 68, 75, 76, 77],
    [04, 13, 22, 31, 40, 49, 54, 55, 56, 57, 59, 60, 61, 62, 66, 67, 68, 75, 76, 77],
    [05, 14, 23, 32, 41, 50, 54, 55, 56, 57, 58, 60, 61, 62, 66, 67, 68, 75, 76, 77],
    [06, 15, 24, 33, 42, 51, 54, 55, 56, 57, 58, 59, 61, 62, 69, 70, 71, 78, 79, 80],
    [07, 16, 25, 34, 43, 52, 54, 55, 56, 57, 58, 59, 60, 62, 69, 70, 71, 78, 79, 80],
    [08, 17, 26, 35, 44, 53, 54, 55, 56, 57, 58, 59, 60, 61, 69, 70, 71, 78, 79, 80],
    [00, 09, 18, 27, 36, 45, 54, 55, 56, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74],
    [01, 10, 19, 28, 37, 46, 54, 55, 56, 63, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74],
    [02, 11, 20, 29, 38, 47, 54, 55, 56, 63, 64, 66, 67, 68, 69, 70, 71, 72, 73, 74],
    [03, 12, 21, 30, 39, 48, 57, 58, 59, 63, 64, 65, 67, 68, 69, 70, 71, 75, 76, 77],
    [04, 13, 22, 31, 40, 49, 57, 58, 59, 63, 64, 65, 66, 68, 69, 70, 71, 75, 76, 77],
    [05, 14, 23, 32, 41, 50, 57, 58, 59, 63, 64, 65, 66, 67, 69, 70, 71, 75, 76, 77],
    [06, 15, 24, 33, 42, 51, 60, 61, 62, 63, 64, 65, 66, 67, 68, 70, 71, 78, 79, 80],
    [07, 16, 25, 34, 43, 52, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 71, 78, 79, 80],
    [08, 17, 26, 35, 44, 53, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 78, 79, 80],
    [00, 09, 18, 27, 36, 45, 54, 55, 56, 63, 64, 65, 73, 74, 75, 76, 77, 78, 79, 80],
    [01, 10, 19, 28, 37, 46, 54, 55, 56, 63, 64, 65, 72, 74, 75, 76, 77, 78, 79, 80],
    [02, 11, 20, 29, 38, 47, 54, 55, 56, 63, 64, 65, 72, 73, 75, 76, 77, 78, 79, 80],
    [03, 12, 21, 30, 39, 48, 57, 58, 59, 66, 67, 68, 72, 73, 74, 76, 77, 78, 79, 80],
    [04, 13, 22, 31, 40, 49, 57, 58, 59, 66, 67, 68, 72, 73, 74, 75, 77, 78, 79, 80],
    [05, 14, 23, 32, 41, 50, 57, 58, 59, 66, 67, 68, 72, 73, 74, 75, 76, 78, 79, 80],
    [06, 15, 24, 33, 42, 51, 60, 61, 62, 69, 70, 71, 72, 73, 74, 75, 76, 77, 79, 80],
    [07, 16, 25, 34, 43, 52, 60, 61, 62, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 80],
    [08, 17, 26, 35, 44, 53, 60, 61, 62, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79],
];

/// A block index
#[derive(Debug, Clone, Copy, PartialEq)]
pub(crate) struct Block(u8);

/// A single Column value
#[derive(Debug, Clone, Copy, PartialEq)]
pub(crate) struct Col(u8);

/// A single Row value
#[derive(Debug, Clone, Copy, PartialEq)]
pub(crate) struct Row(u8);

/// Position on the board
#[derive(Debug, Clone, Copy, PartialEq)]
pub(crate) struct Pos(u8, u8);

/// One dimensional index on the board
#[derive(Debug, Clone, Copy, PartialEq)]
pub(crate) struct Index(u8);

impl Index {
    /// Returns the row on the board
    #[inline(always)]
    pub fn row(&self) -> Row {
        Row(self.0 / Sudoku::ROWS)
    }

    /// Returns the column on the board
    #[inline(always)]
    pub fn col(&self) -> Col {
        Col(self.0 % Sudoku::COLS)
    }

    /// Returns the position on the board
    #[inline(always)]
    pub fn pos(&self) -> Pos {
        Pos(self.row().0, self.col().0)
    }
}

impl From<Index> for Pos {
    fn from(index: Index) -> Self {
        index.pos()
    }
}

impl Pos {
    pub fn new(row: u8, col: u8) -> Self {
        Self(row, col)
    }

    /// Returns the associated block index.
    ///
    /// Block indices map from the grid as follows.
    ///
    ///   0 0 0 1 1 1 2 2 2
    ///   0 0 0 1 1 1 2 2 2
    ///   0 0 0 1 1 1 2 2 2
    ///   3 3 3 4 4 4 5 5 5
    ///   3 3 3 4 4 4 5 5 5
    ///   3 3 3 4 4 4 5 5 5
    ///   6 6 6 7 7 7 8 8 8
    ///   6 6 6 7 7 7 8 8 8
    ///   6 6 6 7 7 7 8 8 8
    ///
    pub fn block(&self) -> u8 {
        let row = (self.0 / Sudoku::BLOCK_SIZE) % Sudoku::BLOCK_SIZE;
        let col = self.1 / Sudoku::BLOCK_SIZE;
        row * Sudoku::BLOCK_SIZE + col
    }
}

impl Display for Pos {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        write!(f, "({}, {})", self.0, self.1)
    }
}

#[cfg(test)]
mod tests {
    use crate::{Sudoku, types::Pos};

    #[test]
    fn test_pos_block_indices() {
        let expected_blocks: Vec<u8> = vec![
            0, 0, 0, 1, 1, 1, 2, 2, 2,
            0, 0, 0, 1, 1, 1, 2, 2, 2,
            0, 0, 0, 1, 1, 1, 2, 2, 2,
            3, 3, 3, 4, 4, 4, 5, 5, 5,
            3, 3, 3, 4, 4, 4, 5, 5, 5,
            3, 3, 3, 4, 4, 4, 5, 5, 5,
            6, 6, 6, 7, 7, 7, 8, 8, 8,
            6, 6, 6, 7, 7, 7, 8, 8, 8,
            6, 6, 6, 7, 7, 7, 8, 8, 8,
        ];

        for row in 0..Sudoku::ROWS {
            for col in 0..Sudoku::COLS {
                let index = row * Sudoku::ROWS + col;
                assert_eq!(expected_blocks[index as usize], Pos::new(row, col).block());
            }
        }
    }
}
